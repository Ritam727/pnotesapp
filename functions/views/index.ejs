<!DOCTYPE html>
<html>
  <head>
    <!-- Meta tags and title -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pnotes</title>

    <!-- Firebase SCripts, currently using app, auth and database for right now! -->
    <!-- update the version number as needed -->
    <script defer src="/__/firebase/7.14.4/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/7.14.4/firebase-auth.js"></script>
    <script defer src="/__/firebase/7.14.4/firebase-database.js"></script>
    <!-- <script defer src="/__/firebase/7.14.4/firebase-messaging.js"></script> -->
    <!-- <script defer src="/__/firebase/7.14.4/firebase-storage.js"></script> -->
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>

    <!-- Stylesheets -->
    <style media="screen">
      #load { color: rgba(0,0,0,0.4); text-align: center; font-size: 13px;}
      @media (max-width: 600px) {
        body, #message { margin-top: 0; background: white; box-shadow: none; }
      }
    </style>

    <link rel="stylesheet" href="/css/style.css">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    
  </head>
  <body>

    <!-- this line tells which firebase services are loaded or say using here! -->
    <!-- Check script below which tells about the services -->
    <p id="load">Firebase SDK Loading&hellip;</p>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // // ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥
        // // The Firebase SDK is initialized and available here!
        //
        // firebase.auth().onAuthStateChanged(user => { });
        // firebase.database().ref('/path/to/ref').on('value', snapshot => { });
        // firebase.messaging().requestPermission().then(() => { });
        // firebase.storage().ref('/path/to/ref').getDownloadURL().then(() => { });
        //
        // // ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥

        window.signInEmail = "";

        signInfunction=()=>{
            // Start the sign in Activity!
            console.log("Sign In NOw!");

            // Google sign in
            var provider = new firebase.auth.GoogleAuthProvider();
            firebase.auth().signInWithPopup(provider).then(function(result){
                console.log(result);
                console.log("success, check now!");
            }).catch(function(err){
                console.log(err);
                console.log("Failed to do");
            });

            
        //     firebase.auth().signInWithRedirect(provider);

        //     firebase.auth().getRedirectResult()
        //         .then(function(result) {

        //             if (result.credential) {
        //                 // This gives you a Google Access Token. You can use it to access the Google API.
        //                 var token = result.credential.accessToken;
        //                 // ...
        //             }
        //             // The signed-in user info.
        //             var user = result.user;
        //             console.log("Sign In success!");
        //             console.log(user);
                    
        //         })
        //         .catch(function(error) {
        //             // Handle Errors here.
        //             console.log("Sign In Failed!");
        //             var errorCode = error.code;
        //             var errorMessage = error.message;
        //             // The email of the user's account used.
        //             var email = error.email;
        //             // The firebase.auth.AuthCredential type that was used.
        //             var credential = error.credential;
        //             // ...
        //         });

        }

        // This get the note list and also updates it
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                console.log("User is signed in!");
                var len = user.email.length;
                //console.log(len);
                window.signInEmail = user.email.toString().substr(0, len-10); //Removing the @gmail.com
                console.log(window.signInEmail);
                document.getElementById('guser').innerHTML = "Welcome "+window.signInEmail;
                document.getElementById('signInButton').style.display = "none";
                document.getElementById('signOutButton').style.display = "block";
                document.getElementById('addNoteButton').style.display = "block";

                // Now call the data extract for only once so as to get the list of datas
                firebase.database().ref(window.signInEmail).orderByChild('timestamp').on('value', function(snapshot){
                        
                    // Get the id of the list
                    var noteListId = document.getElementById('note-family');
                    
                    //Clear the list
                    noteListId.innerHTML ='';
                    
                    //console.log(snapshot);

                    var descNoteList = [];

                    snapshot.forEach(function(childSnapshot) {
                        var childKey = childSnapshot.key;
                        var childData = childSnapshot.val();
                        //console.log("childkey", childKey);
                        //console.log("childData", childData);
                        // ...
                        descNoteList.push({childKey: childKey, childData: childData});
                        
                    });

                    // Reverse the array
                    descNoteList.reverse();

                    descNoteList.forEach(function(childSnapshot){
                        var childKey = childSnapshot.childKey;
                        var childData = childSnapshot.childData;

                        //Setting the value
                        noteListId.innerHTML += '<div id="noterow">' 
                            + '<p id="notekey">' + childKey + '</p>'
                            + '<h6 id="note-date">' + childData.date + '</h6>' 
                            + '<h3 id="note-title">' + childData.title + '</h3>'
                            + '<p id="note-description">' + childData.description + '</p>'
                            + '</div>';
                    });
                });

                //list(family);

                // Here the firebase is correctly defined purely!
                //console.log(firebase.database.ServerValue.TIMESTAMP);

                addNotefunction=(title, description)=>{
                    //Start the add note function
                    console.log("Add Note");
                    
                    var newNote = {
                        title: title,
                        description: description,
                        date: "May 20",
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    }

                    // Get a key for a new Post.
                    var newPostKey = firebase.database().ref(window.signInEmail).push().key;

                    // Write the new post's data simultaneously in the posts list and the user's post list.
                    var updates = {};
                    updates[newPostKey] = newNote;

                    return firebase.database().ref(window.signInEmail).update(updates);
                }
                
            } else {
                console.log("NO user signed in!");
                window.signInEmail = "";
                document.getElementById('guser').innerHTML = "Welcome to Pnotes!";
                document.getElementById('signInButton').style.display = "block";
                document.getElementById('signOutButton').style.display = "none";
                document.getElementById('addNoteButton').style.display = "none";
                document.getElementById('note-family').innerHTML = '';
                // No user is signed in.
            }
        });


        // Tell which firebase apps are active
        try {
          let app = firebase.app();
          let features = ['auth', 'database', 'messaging', 'storage'].filter(feature => typeof app[feature] === 'function');
          document.getElementById('load').innerHTML = `Firebase SDK loaded with ${features.join(', ')}`;
        } catch (e) {
          console.error(e);
          document.getElementById('load').innerHTML = 'Error loading the Firebase SDK, check the console.';
        }
      });

      
    </script>

    <!-- Sign Out function -->
    <script>
        signOutfunction=()=>{
            //Start the user delete or sign out activity
            console.log("Sign Out User!");

            var user = firebase.auth().signOut();
        }
    </script>



    <!-- Main content -->
    <div class="container">

        <div id="message">
            <span class="heading" id="guser"> Weclome to Pnotes!</span>
            <button onclick="signInfunction()" class='btn btn-success pull-right' id="signInButton">Google Sign In!</button>
            <button onclick="signOutfunction()" class='btn btn-success pull-right' id="signOutButton">Sign out</button>
            <button class='btn btn-success pull-right' id="addNoteButton">Add Note</button>

            <div id="note-family">
            </div>
        </div>

        <!-- The Modal -->
        <div id="myModal" class="modal">

            <!-- Modal content -->
            <div class="modal-content">
                <!-- Heading and close button -->
                <span class="close">&times;</span>
                <h3 style="margin-top: 5px !important;">Add Note</h3>

                <!-- Function to add a note-->

                    <!-- Title -->
                    <div class="form-group">
                        <input id="add-title" type="text" class="form-control input-contrast input-block" placeholder="Note Title">
                    </div>

                    <!-- Description -->
                    <div class="form-group">
                        <textarea id="add-description" type="text" class="form-control input-contrast input-block" placeholder="Add Note Description here"></textarea>
                    </div>
                    
                    <!-- Submit Button --> <!-- Changed it to have it only for function -->
                    <div style="text-align: center; margin-top: 16px;">
                        <button id="add-note-submit-button">Add Note</button>
                    </div>
                
            </div>
        
        </div>

    </div>

    <!-- Script for all add note form and all -->
    <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var addbtn = document.getElementById("addNoteButton");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal 
        addbtn.onclick = function() {
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
          modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        // window.onclick = function(event) {
        //   if (event.target == modal) {
        //     modal.style.display = "none";
        //   }
        // }

        // Now for the submit button
        var submitAddNote = document.getElementById('add-note-submit-button');

        submitAddNote.onclick = function(){
            
            var addNoteTitle = document.getElementById('add-title').value;
            var addNoteDescription = document.getElementById('add-description').value;
            //console.log(addNoteTitle);
            //console.log(addNoteDescription);
            if(addNoteTitle){
                // Note title not empty
                // Now do the thing which you want to do call addNotefunction
                addNotefunction(addNoteTitle, addNoteDescription);
                modal.style.display = "none";

            } else{
                //Empty
                console.log("Empty Note Title");
                modal.style.display = "none";
            }
        }
        

    </script>
        
    
  </body>
</html>
